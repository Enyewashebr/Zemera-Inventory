<section class="products">
  <div class="section-header">
    <h2>Product management</h2>
    <p>Manage the master product list with validation and edit safeguards.</p>
  </div>

  <div class="product-layout">
        <div class="product-table-card">
      <div class="table-header">
        <h3>Product list</h3>
        <span class="table-hint">Click edit to update details (unit locked during edit).</span>
      </div>
      <div class="search-bar">
        <input
          type="text"
          [(ngModel)]="searchTerm"
          (input)="onSearchChange()"
          placeholder="Search products by name, category, subcategory, or unit..."
          class="search-input"
        />
        @if (searchTerm) {
          <button class="clear-search" (click)="searchTerm = ''; filterProducts()" aria-label="Clear search">
            ✕
          </button>
        }
        <span class="search-results">{{ products.length }} of {{ allProducts.length }} products</span>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Product Name</th>
                    <th>Category</th>
                    <th>Subcategory</th>
              <th>Unit</th>
              <th>Buying Price</th>
              <th>Selling Price</th>
              <th>Current Stock</th>
                    <th>Sellable</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (product of products; track product.id) {
              <tr>
                <td>{{ product.name }}</td>
                      <td>{{ product.categoryName }}</td>
                      <td>{{ product.subcategory || '—' }}</td>
                <td>{{ product.unit }}</td>
                <td>{{ product.buyingPrice | currency: 'ETB':'symbol':'1.2-2' }}</td>
                <td>{{ product.sellingPrice | currency: 'ETB':'symbol':'1.2-2' }}</td>
                <td>{{ product.stock | number }}</td>
                      <td>{{ product.sellable ? 'Yes' : 'No' }}</td>
                <td>
                  <button class="link-btn" (click)="startEdit(product.id)">Edit</button>
                </td>
              </tr>
            }
            @if (products.length === 0) {
              <tr>
                <td colspan="7" class="empty-row">No products yet. Add a new product to get started.</td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>

    <div class="product-form-card">
      <div class="form-header">
        <div>
          <h3>{{ editingProductId ? 'Edit product' : 'Add product' }}</h3>
          <p class="form-hint">
            Product name must be unique. Unit is disabled while editing. Stock is read-only after creation.
          </p>
        </div>
        @if (editingProductId) {
          <button class="ghost small" type="button" (click)="resetForm()">Cancel edit</button>
        }
      </div>

      <form (ngSubmit)="submitProduct()" #productFormRef="ngForm" class="product-form">
        <label>
          <span>Product Name</span>
          <input
            name="name"
            [(ngModel)]="productForm.name"
            type="text"
            placeholder="e.g., Dashen Beer, Water 0.5L, Tibs"
            required
          />
          @if (formErrors['name']) {
            <span class="error">{{ formErrors['name'] }}</span>
          }
        </label>

        <label>
          <span>Category</span>
          <select name="categoryId" [(ngModel)]="productForm.categoryId" required>
            <option value="" disabled>Select category</option>
            @for (cat of categories; track cat.id) {
              <option [value]="cat.id">{{ cat.name }}</option>
            }
          </select>
          @if (formErrors['category']) {
            <span class="error">{{ formErrors['category'] }}</span>
          }
        </label>

        <label>
          <span>Subcategory</span>
          <select
            name="subcategory"
            [(ngModel)]="productForm.subcategory"
            [disabled]="!selectedCategory || availableSubcategories.length === 0"
          >
            <option value="" disabled>
              {{ availableSubcategories.length ? 'Select subcategory' : 'No subcategories' }}
            </option>
            @for (sub of availableSubcategories; track sub) {
              <option [value]="sub">{{ sub }}</option>
            }
          </select>
          @if (formErrors['subcategory']) {
            <span class="error">{{ formErrors['subcategory'] }}</span>
          }
        </label>

        <label>
          <span>Unit</span>
          <select
            name="unit"
            [(ngModel)]="productForm.unit"
            [disabled]="editingProductId !== null"
            required
          >
            <option value="" disabled>Select unit</option>
            @for (unit of availableUnits; track unit) {
              <option [value]="unit">{{ unit }}</option>
            }
          </select>
          @if (editingProductId !== null) {
            <span class="field-note">Unit cannot be changed during edit.</span>
          }
          @if (formErrors['unit']) {
            <span class="error">{{ formErrors['unit'] }}</span>
          }
        </label>

        <div class="form-grid">
          <label>
            <span>Buying Price</span>
            <input
              name="buyingPrice"
              [(ngModel)]="productForm.buyingPrice"
              type="number"
              step="0.01"
              min="0"
              required
            />
            @if (formErrors['buyingPrice']) {
              <span class="error">{{ formErrors['buyingPrice'] }}</span>
            }
          </label>
          <label>
            <span>Selling Price</span>
            <input
              name="sellingPrice"
              [(ngModel)]="productForm.sellingPrice"
              type="number"
              step="0.01"
              min="0"
              required
            />
            @if (formErrors['sellingPrice']) {
              <span class="error">{{ formErrors['sellingPrice'] }}</span>
            }
          </label>
        </div>

        <label>
          <span>Sellable</span>
          <select
            name="sellable"
            [(ngModel)]="productForm.sellable"
            [disabled]="selectedCategory?.id === 'cleaning'"
          >
            <option [ngValue]="true">Yes</option>
            <option [ngValue]="false">No</option>
          </select>
          @if (selectedCategory?.id === 'cleaning') {
            <span class="field-note">Cleaning materials are always non-sellable.</span>
          }
        </label>

        @if (editingProductId === null) {
          <label>
            <span>Initial Stock</span>
            <input
              name="initialStock"
              [(ngModel)]="productForm.initialStock"
              type="number"
              min="0"
              required
            />
            @if (formErrors['initialStock']) {
              <span class="error">{{ formErrors['initialStock'] }}</span>
            }
          </label>
        } @else {
          <label>
            <span>Current Stock (read-only after creation)</span>
            <input type="number" [value]="editingProduct?.stock"  editable/>
          </label>
        }

        <div class="form-actions">
          <button class="primary" type="submit">
            {{ editingProductId ? 'Save changes' : 'Add product' }}
          </button>
          <button class="ghost" type="button" (click)="resetForm()">Clear</button>
        </div>
      </form>
    </div>
  </div>
</section>


