<section class="purchases">

  <div class="section-header">
    <h2>Purchase Management</h2>
    <p>Branch managers record purchases. Super manager approves or declines.</p>
  </div>

  <div class="layout">

    <!-- ADD PURCHASE FORM (Only Branch Manager) -->
    <div class="form-card" *ngIf="isBranchManager">
      <h3>Add Purchase</h3>

      <form (ngSubmit)="savePurchase()" class="purchase-form">

        <label>
          <span>Product *</span>
          <select [(ngModel)]="form.productId" name="productId" required>
            <option value="" disabled>Select product</option>
            <option *ngFor="let p of products" [value]="p.id">
              {{ p.name }} ({{ p.unit }})
            </option>
          </select>
          <span class="error" *ngIf="formErrors.productId">{{ formErrors.productId }}</span>
        </label>

        <label>
          <span>Quantity *</span>
          <input type="number" [(ngModel)]="form.quantity" name="quantity" min="1" (input)="calculateTotal()">
          <span class="error" *ngIf="formErrors.quantity">{{ formErrors.quantity }}</span>
        </label>

        <label>
          <span>Unit Price *</span>
          <input type="number" [(ngModel)]="form.unitPrice" name="unitPrice" min="0" step="0.01" (input)="calculateTotal()">
          <span class="error" *ngIf="formErrors.unitPrice">{{ formErrors.unitPrice }}</span>
        </label>

        <label>
          <span>Purchase Date *</span>
          <input type="date" [(ngModel)]="form.purchaseDate" name="purchaseDate" required>
        </label>

        <div>
          Total Cost: {{ totalCost | currency:'ETB':'symbol':'1.2-2' }}
        </div>

        <div class="actions">
          <button class="primary" type="submit" [disabled]="isSaving">Save Purchase</button>
          <button class="ghost" type="button" (click)="clearForm()">Clear Form</button>
        </div>

        <div class="success" *ngIf="successMessage">{{ successMessage }}</div>

      </form>
    </div>

    <!-- PURCHASE HISTORY TABLE -->
    <div class="history-card">
      <h3>Purchase History</h3>
      <div *ngIf="isSuperManager" class="filter-card">
  <label>
    Select Branch
    <select [(ngModel)]="selectedBranchId" (change)="onBranchChange()">
      <option [ngValue]="null">-- Select Branch --</option>
      <option *ngFor="let b of branches" [ngValue]="b.id">
        {{ b.name }}
      </option>
    </select>
  </label>
</div>

      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Product</th>
            <th>Quantity</th>
            <th>Unit Price</th>
            <th>Total Cost</th>
            <th>Status</th>
            <th>Approved By</th>
            <th *ngIf="isSuperManager">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let p of purchases">
            <td>{{ p.purchaseDate }}</td>
            <td>{{ p.productName || p.productId }}</td>
            <td>{{ p.quantity }}</td>
            <td>{{ p.unitPrice | currency:'ETB':'symbol':'1.2-2' }}</td>
            <td>{{ p.totalCost | currency:'ETB':'symbol':'1.2-2' }}</td>
            <td>{{ p.status }}</td>
            <td>{{ p.approvedBy || 'â€”' }}</td>
            <td *ngIf="isSuperManager">
              <button *ngIf="p.status === 'PENDING'" class="primary" (click)="approvePurchase(p.id)">
                Approve
              </button>
              <button *ngIf="p.status === 'PENDING'" class="ghost" (click)="declinePurchase(p.id)">
                Decline
              </button>
            </td>
          </tr>
          <tr *ngIf="purchases.length === 0">
            <td colspan="8" class="empty-row">No purchases recorded yet.</td>
          </tr>
        </tbody>
      </table>
    </div>

  </div>
</section>
